version: '3.8'
services:
  web:
    build:
      context: https://github.com/walshy828/auto_voter.git#main
      dockerfile: Dockerfile
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    environment:
      - FLASK_ENV=production
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
      # VPN removed from web service to prevent UI freezing
      # - EXPRESSVPN_ACTIVATION_CODE=${EXPRESSVPN_ACTIVATION_CODE}
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASS=${ADMIN_PASS}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - AUTO_VOTER_DB=sqlite:///./data/auto_voter.db
      - AUTO_VOTER_LOG_DIR=./data/logs
      - INFLUX_URL=${INFLUX_URL}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
      - TOR_SOCKS_PORT=${TOR_SOCKS_PORT:-9050}
      - TOR_CONTROL_PORT=${TOR_CONTROL_PORT:-9051}
      - TOR_PASSWORD=${TOR_PASSWORD:-welcomeTomyPa55word}
    ports:
      - "8282:8080"
    volumes:
      - /docker/auto_voter/data:/app/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  scheduler:
    build:
      context: https://github.com/walshy828/auto_voter.git#main
      dockerfile: Dockerfile
    command: python app/scheduler_service.py
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    environment:
      - AUTO_VOTER_SCHEDULE_INTERVAL=${AUTO_VOTER_SCHEDULE_INTERVAL:-10}
      - EXPRESSVPN_ACTIVATION_CODE=${EXPRESSVPN_ACTIVATION_CODE}
      - AUTO_VOTER_DB=sqlite:///./data/auto_voter.db
      - AUTO_VOTER_LOG_DIR=./data/logs
      - INFLUX_URL=${INFLUX_URL}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
      - TOR_SOCKS_PORT=${TOR_SOCKS_PORT:-9050}
      - TOR_CONTROL_PORT=${TOR_CONTROL_PORT:-9051}
      - TOR_PASSWORD=${TOR_PASSWORD:-welcomeTomyPa55word}
    volumes:
      - /docker/auto_voter/data:/app/data
    restart: unless-stopped
