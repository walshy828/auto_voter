version: '3.8'
services:
  web:
    build:
      context: https://github.com/walshy828/auto_voter.git#main
      dockerfile: Dockerfile.web
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    environment:
      - FLASK_ENV=production
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
      # VPN removed from web service to prevent UI freezing
      # - EXPRESSVPN_ACTIVATION_CODE=${EXPRESSVPN_ACTIVATION_CODE}
      # Disable internal scheduler so only the dedicated scheduler container runs jobs
      - ENABLE_INTERNAL_SCHEDULER=false
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASS=${ADMIN_PASS}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - AUTO_VOTER_DB=sqlite:///./data/auto_voter.db
      - AUTO_VOTER_LOG_DIR=./data/logs
      - INFLUX_URL=${INFLUX_URL}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
      - TOR_SOCKS_PORT=${TOR_SOCKS_PORT:-9050}
      - TOR_CONTROL_PORT=${TOR_CONTROL_PORT:-9051}
      - TOR_PASSWORD=${TOR_PASSWORD:-welcomeTomyPa55word}
      # Performance optimizations
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONOPTIMIZE=2
      - MALLOC_TRIM_THRESHOLD_=100000
    ports:
      - "8282:8080"
    volumes:
      - /docker/auto_voter/data:/app/data
    restart: unless-stopped
    # Resource limits to prevent memory bloat
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  scheduler:
    build:
      context: https://github.com/walshy828/auto_voter.git#main
      dockerfile: Dockerfile.scheduler
    command: python app/scheduler_service.py
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    environment:
      - AUTO_VOTER_SCHEDULE_INTERVAL=${AUTO_VOTER_SCHEDULE_INTERVAL:-60}
      - EXPRESSVPN_ACTIVATION_CODE=${EXPRESSVPN_ACTIVATION_CODE}
      - AUTO_VOTER_DB=sqlite:///./data/auto_voter.db
      - AUTO_VOTER_LOG_DIR=./data/logs
      - INFLUX_URL=${INFLUX_URL}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
      - TOR_SOCKS_PORT=${TOR_SOCKS_PORT:-9050}
      - TOR_CONTROL_PORT=${TOR_CONTROL_PORT:-9051}
      - TOR_PASSWORD=${TOR_PASSWORD:-welcomeTomyPa55word}
      # Performance optimizations
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONOPTIMIZE=2
      - MALLOC_TRIM_THRESHOLD_=100000
    volumes:
      - /docker/auto_voter/data:/app/data
    restart: unless-stopped
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '1.5'
        reservations:
          memory: 384M
          cpus: '0.75'
    # Healthcheck for scheduler (check if process is running)
    healthcheck:
      test: [ "CMD", "pgrep", "-f", "scheduler_service.py" ]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 45s
